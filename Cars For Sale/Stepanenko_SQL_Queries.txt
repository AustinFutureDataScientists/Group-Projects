WITH
ds AS
(
  SELECT
    transaction_date,
    type,
    COALESCE(amount,0) AS deposit
  FROM transactions
  WHERE type='deposit'
  ORDER BY transaction_date
),
ws AS
(
  SELECT
    transaction_date,
    type,
    COALESCE(amount,0) AS withdrawal
  FROM transactions
  WHERE type='withdrawal'
  ORDER BY transaction_date
),
combined_table AS
(
  SELECT
  COALESCE(ds.transaction_date, ws.transaction_date) AS date,
  COALESCE(deposit,0) AS deposit,
  COALESCE(withdrawal,0) AS withdrawal

  FROM ds
  FULL OUTER JOIN ws
  ON ds.transaction_date=ws.transaction_date
  ORDER BY COALESCE(ds.transaction_date, ws.transaction_date)
),
balance AS
(
  SELECT DISTINCT
  date,
  SUM(deposit-withdrawal)
    OVER
    (
      PARTITION BY DATE_TRUNC('month',date) ORDER BY date
    )
  AS day_balance
  FROM
  combined_table
  ORDER BY date
)
SELECT * FROM balance;
